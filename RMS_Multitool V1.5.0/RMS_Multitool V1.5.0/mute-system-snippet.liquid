{% comment %}
  ═══════════════════════════════════════════════════════════════════════════════
  RMS MULTITOOL — MUTE SYSTEM (Liquid Snippet for CurrentRMS Quote Templates)
  Version: 1.0
  ═══════════════════════════════════════════════════════════════════════════════

  PURPOSE:
  Works with the RMS Multitool Chrome Extension's quote mute feature.
  When a group or item is muted via the extension, this Liquid code:
    1. Hides the muted groups/items from the rendered PDF
    2. Subtracts their charges from all totals (cost summary, subtotals, grand total)

  HOW IT WORKS:
  The extension writes [MUTED:charge:tax] into group names and [MUTED] into
  item descriptions via the CurrentRMS API. This snippet parses those tags,
  sums the muted amounts, and subtracts them from the order totals.

  ─────────────────────────────────────────────────────────────────────────────
  SETUP INSTRUCTIONS:
  ─────────────────────────────────────────────────────────────────────────────

  STEP 1 — PASTE SECTION A at the very top of your template body (before any HTML).
           This calculates the muted totals.

  STEP 2 — REPLACE all references to order totals with the active_* variables:

           INSTEAD OF:                         USE:
           order.charge_excluding_tax_total  →  active_ex_tax
           order.tax_total                   →  active_tax_total
           order.rental_charge_total         →  active_rental_total
           order.service_charge_total        →  active_service_total
           order.sale_charge_total           →  active_sale_total

           For totals including tax, use:       active_inc_tax

           For visibility checks, use:
             {% assign check_rental = active_rental_total | plus: 0 %}
             {% if check_rental != 0 %}...{% endif %}

  STEP 3 — WRAP your item rendering loop with SECTION B (the rendering filter).
           This hides muted groups/items from the PDF output.

  STEP 4 — UPDATE any subtotal rows to use adjusted values (see Section B notes).

  ─────────────────────────────────────────────────────────────────────────────
  COMPATIBILITY:
  ─────────────────────────────────────────────────────────────────────────────
  • Works with nested groups at any depth
  • Handles both group-level muting and individual item muting
  • Compatible with *HIDE* tag system (if you use it)
  • Multi-user safe — state is stored in the API, not the browser
  • No muted items = no effect (all active_* variables equal order.* values)

  ═══════════════════════════════════════════════════════════════════════════════
{% endcomment %}


{% comment %}
  ═══════════════════════════════════════════════════════════════════════════════
  SECTION A — CALCULATION BLOCK
  Paste this at the VERY TOP of your quote template body, before any HTML.
  ═══════════════════════════════════════════════════════════════════════════════
{% endcomment %}

{% assign has_any_muted = false %}
{% assign muted_charge_sum = 0.0 | plus: 0 %}
{% assign muted_tax_sum = 0.0 | plus: 0 %}
{% assign inside_muted_group = false %}
{% assign muted_grp_depth = 99 %}

{% for item in order.items %}
  {% if item.is_group? %}
    {% if inside_muted_group and item.depth <= muted_grp_depth %}
      {% assign inside_muted_group = false %}
      {% assign muted_grp_depth = 99 %}
    {% endif %}
    {% if item.name contains '[MUTED' %}
      {% assign has_any_muted = true %}
      {% unless inside_muted_group %}
        {% assign mute_parts = item.name | split: '[MUTED:' %}
        {% if mute_parts.size > 1 %}
          {% assign mute_values = mute_parts[1] | split: ']' %}
          {% assign mute_nums = mute_values[0] | split: ':' %}
          {% if mute_nums.size >= 1 %}
            {% assign muted_charge_sum = muted_charge_sum | plus: mute_nums[0] %}
          {% endif %}
          {% if mute_nums.size >= 2 %}
            {% assign muted_tax_sum = muted_tax_sum | plus: mute_nums[1] %}
          {% endif %}
        {% endif %}
        {% assign inside_muted_group = true %}
        {% assign muted_grp_depth = item.depth %}
      {% endunless %}
    {% endif %}
  {% elsif item.is_subtotal? %}
    {% if inside_muted_group and item.depth <= muted_grp_depth %}
      {% assign inside_muted_group = false %}
      {% assign muted_grp_depth = 99 %}
    {% endif %}
  {% else %}
    {% if item.description contains '[MUTED' %}
      {% assign has_any_muted = true %}
      {% unless inside_muted_group %}
        {% assign item_mute_parts = item.description | split: '[MUTED:' %}
        {% if item_mute_parts.size > 1 %}
          {% assign item_mute_values = item_mute_parts[1] | split: ']' %}
          {% assign item_mute_nums = item_mute_values[0] | split: ':' %}
          {% if item_mute_nums.size >= 1 %}
            {% assign muted_charge_sum = muted_charge_sum | plus: item_mute_nums[0] %}
          {% endif %}
          {% if item_mute_nums.size >= 2 %}
            {% assign muted_tax_sum = muted_tax_sum | plus: item_mute_nums[1] %}
          {% endif %}
        {% endif %}
      {% endunless %}
    {% endif %}
  {% endif %}
{% endfor %}

{% assign active_ex_tax = order.charge_excluding_tax_total | minus: muted_charge_sum %}
{% assign active_tax_total = order.tax_total | minus: muted_tax_sum %}
{% assign active_inc_tax = active_ex_tax | plus: active_tax_total %}
{% assign active_rental_total = order.rental_charge_total | minus: muted_charge_sum %}
{% assign active_service_total = order.service_charge_total %}
{% assign active_sale_total = order.sale_charge_total %}


{% comment %}
  ═══════════════════════════════════════════════════════════════════════════════
  SECTION B — RENDERING FILTER
  Wrap your item rendering loop (the {% for item in order.items %} block)
  with this logic to hide muted groups and items from the PDF.

  NOTE: Adapt the HTML inside to match YOUR template's structure.
  The example below shows a typical 4-column table layout.
  ═══════════════════════════════════════════════════════════════════════════════
{% endcomment %}

{%- comment %} ═══ Mute rendering state variables ═══ {% endcomment %}
{%- assign render_hidden = false -%}
{%- assign render_hidden_depth = 99 -%}
{%- assign render_muted = false -%}
{%- assign render_muted_depth = 99 -%}
{%- assign current_d1_has_muted = false -%}

{%- for item in order.items -%}
  {%- if item.is_group? -%}
    {%- comment %} Exit hidden/muted group when we reach a sibling or parent {% endcomment %}
    {%- if render_hidden and item.depth <= render_hidden_depth -%}
      {%- assign render_hidden = false -%}
      {%- assign render_hidden_depth = 99 -%}
    {%- endif -%}
    {%- if render_muted and item.depth <= render_muted_depth -%}
      {%- assign render_muted = false -%}
      {%- assign render_muted_depth = 99 -%}
    {%- endif -%}

    {%- comment %} Enter hidden/muted state {% endcomment %}
    {%- if item.name contains '*HIDE*' -%}
      {%- assign render_hidden = true -%}
      {%- assign render_hidden_depth = item.depth -%}
    {%- elsif item.name contains '[MUTED' -%}
      {%- assign render_muted = true -%}
      {%- assign render_muted_depth = item.depth -%}
      {%- assign current_d1_has_muted = true -%}
    {%- endif -%}

    {%- comment %} Reset d1 muted tracker at each new depth-1 group {% endcomment %}
    {%- if item.depth == 1 -%}
      {%- assign current_d1_has_muted = false -%}
      {%- if item.name contains '[MUTED' -%}
        {%- assign current_d1_has_muted = true -%}
      {%- endif -%}
    {%- endif -%}

    {%- comment %} Render group header only if visible (strip [MUTED...] from name) {% endcomment %}
    {%- unless render_hidden or render_muted -%}
      {%- assign clean_group_name = item.name | split: ' [MUTED' | first -%}
      <tr>
        <td colspan="4">
          <strong>{{ clean_group_name }}</strong>
        </td>
      </tr>
    {%- endunless -%}

  {%- elsif item.is_subtotal? -%}
    {%- if render_hidden and item.depth <= render_hidden_depth -%}
      {%- assign render_hidden = false -%}
      {%- assign render_hidden_depth = 99 -%}
    {%- endif -%}
    {%- if render_muted and item.depth <= render_muted_depth -%}
      {%- assign render_muted = false -%}
      {%- assign render_muted_depth = 99 -%}
    {%- endif -%}

    {%- unless render_hidden or render_muted -%}
      {%- if item.depth == 1 -%}
        {%- comment %} Clean label and only adjust subtotal for the group containing muted items {% endcomment %}
        {%- assign clean_subtotal_name = item.subtotal_name | split: ' [MUTED' | first -%}
        {%- if current_d1_has_muted -%}
          {%- assign adjusted_subtotal = item.subtotal | minus: muted_charge_sum -%}
          <tr>
            <td colspan="2">Total {{ clean_subtotal_name }}:</td>
            <td colspan="2">{{ adjusted_subtotal | currency }}</td>
          </tr>
        {%- else -%}
          <tr>
            <td colspan="2">Total {{ clean_subtotal_name }}:</td>
            <td colspan="2">{{ item.subtotal | currency }}</td>
          </tr>
        {%- endif -%}
        {%- assign current_d1_has_muted = false -%}
      {%- endif -%}
    {%- endunless -%}

  {%- elsif item.is_item? and item.is_accessory? == false -%}
    {%- unless render_hidden or render_muted -%}
      {%- unless item.description contains '[MUTED' -%}
        <tr>
          {%- comment %} ADAPT THIS to your template's item row structure {% endcomment -%}
          <td>{{ item.name }}</td>
          <td>{{ item.description }}</td>
          <td>{{ item.quantity }}</td>
          <td>{{ item.charge_period_name }}</td>
        </tr>
      {%- endunless -%}
    {%- endunless -%}

  {%- endif -%}
{%- endfor -%}


{% comment %}
  ═══════════════════════════════════════════════════════════════════════════════
  SECTION C — COST SUMMARY EXAMPLE
  Replace your existing cost summary with something like this.
  Uses active_* variables so muted charges are excluded.
  ═══════════════════════════════════════════════════════════════════════════════
{% endcomment %}

{% assign check_rental = active_rental_total | plus: 0 %}
{% assign check_service = active_service_total | plus: 0 %}
{% assign check_sale = active_sale_total | plus: 0 %}

{% if check_rental != 0 %}
<tr>
  <td>Equipment Hire:</td>
  <td>{{ active_rental_total | currency }}</td>
</tr>
{% endif %}

{% if check_service != 0 %}
<tr>
  <td>Labour / Services:</td>
  <td>{{ active_service_total | currency }}</td>
</tr>
{% endif %}

{% if check_sale != 0 %}
<tr>
  <td>Sale Items:</td>
  <td>{{ active_sale_total | currency }}</td>
</tr>
{% endif %}

<tr>
  <td>Subtotal (Ex Tax):</td>
  <td>{{ active_ex_tax | currency }}</td>
</tr>
<tr>
  <td>Tax:</td>
  <td>{{ active_tax_total | currency }}</td>
</tr>
<tr>
  <td><strong>Total (Inc Tax):</strong></td>
  <td><strong>{{ active_inc_tax | currency }}</strong></td>
</tr>
